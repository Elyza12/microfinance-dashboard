<script>
if(localStorage.getItem("loggedIn") !== "true"){
  window.location.href = "login.html";
}

const API_URL = "https://script.google.com/macros/s/AKfycbzJPQZw9vc81-X2GzYKUB44tk7q7IJQJG7lfmVG8mAnjcBOED0Jn700WmH13-Zv2ZJTDQ/exec";

const loanModal = new bootstrap.Modal(document.getElementById("loanModal"));
const paymentModal = new bootstrap.Modal(document.getElementById("paymentModal"));

// ----------------------
// FETCH DATA
// ----------------------
async function fetchBorrowers() {
  const res = await fetch(`${API_URL}?action=borrowers`);
  return await res.json();
}

async function fetchLoans() {
  const res = await fetch(`${API_URL}?action=loans`);
  return await res.json();
}

// ----------------------
// LOAD LOANS TABLE
// ----------------------
async function loadLoansTable() {
  const loans = await fetchLoans();
  const borrowers = await fetchBorrowers();
  const table = document.getElementById("loansTable");
  table.innerHTML = "";

  let borrowerMap = {};
  borrowers.forEach(b => borrowerMap[b.BorrowerID] = b.FullName);

  loans.sort((a,b)=> new Date(b.StartDate) - new Date(a.StartDate));

  loans.forEach(loan => {
    const borrowerName = borrowerMap[loan.BorrowerID] || "Unknown";
    const totalPayable = Number(loan.Amount) + (Number(loan.Amount) * Number(loan.Interest)/100);
    const remainingBalance = loan.RemainingBalance ?? totalPayable;

    table.innerHTML += `
      <tr>
        <td>${loan.LoanID}</td>
        <td>${borrowerName}</td>
        <td>₱${Number(loan.Amount).toFixed(2)}</td>
        <td>${loan.Interest}</td>
        <td>₱${totalPayable.toFixed(2)}</td>
        <td>₱${remainingBalance.toFixed(2)}</td>
        <td>${formatDate(loan.StartDate)}</td>
        <td>${formatDate(loan.DueDate)}</td>
        <td>${loan.Status}</td>
        <td>
          <button class="btn btn-sm btn-warning payLoanBtn" 
            data-id="${loan.LoanID}" 
            data-balance="${remainingBalance}">
            Pay
          </button>
        </td>
        <td>
          <button class="btn btn-sm btn-primary editLoanBtn" 
            data-id="${loan.LoanID}" 
            data-borrower="${loan.BorrowerID}"
            data-amount="${loan.Amount}"
            data-interest="${loan.Interest}"
            data-start="${loan.StartDate}"
            data-due="${loan.DueDate}"
            data-status="${loan.Status}">
            Edit
          </button>
          <button class="btn btn-sm btn-danger deleteLoanBtn" data-id="${loan.LoanID}">Delete</button>
        </td>
      </tr>
    `;
  });
}

// ----------------------
// BORROWER DROPDOWN
// ----------------------
async function populateBorrowersDropdown() {
  const borrowers = await fetchBorrowers();
  loanBorrower.innerHTML = "";
  borrowers.forEach(b => {
    loanBorrower.innerHTML += `<option value="${b.BorrowerID}">${b.FullName}</option>`;
  });
}

// ----------------------
// FORMAT DATE
// ----------------------
function formatDate(dateString){
  if(!dateString) return "";
  return new Date(dateString).toLocaleDateString("en-US", {year:'numeric', month:'long', day:'numeric'});
}

// ----------------------
// HANDLE CLICK EVENTS
// ----------------------
document.addEventListener("click", async e => {

  // Delete Loan
  if(e.target.classList.contains("deleteLoanBtn")){
    if(confirm("Delete loan?")){
      await fetch(`${API_URL}?action=deleteLoan&id=${e.target.dataset.id}`);
      loadLoansTable();
    }
  }

  // Edit Loan
  if(e.target.classList.contains("editLoanBtn")){
    await populateBorrowersDropdown();

    loanId.value = e.target.dataset.id;
    loanBorrower.value = e.target.dataset.borrower;
    loanAmount.value = e.target.dataset.amount;
    loanInterest.value = e.target.dataset.interest;
    loanStart.value = e.target.dataset.start;
    loanDue.value = e.target.dataset.due;
    loanStatus.value = e.target.dataset.status;

    calculateTotalPayable();
    loanModal.show();
  }

  // Make Payment
  if(e.target.classList.contains("payLoanBtn")){
    paymentLoanId.value = e.target.dataset.id;
    paymentRemaining.value = Number(e.target.dataset.balance).toFixed(2);
    paymentAmount.value = "";
    paymentModal.show();
  }
});

// ----------------------
// SUBMIT PAYMENT
// ----------------------
document.getElementById("savePaymentBtn").addEventListener("click", async () => {
  const loanId = paymentLoanId.value;
  const payment = Number(paymentAmount.value);
  const remaining = Number(paymentRemaining.value);

  if(payment <= 0 || payment > remaining){
    return alert("Invalid payment amount");
  }

  await fetch(`${API_URL}?action=makePayment&id=${loanId}&amount=${payment}`);

  paymentModal.hide();
  await loadLoansTable();
});

// ----------------------
// SUBMIT LOAN FORM
// ----------------------
loanForm.addEventListener("submit", async e => {
  e.preventDefault();
  const id = loanId.value;
  const borrower = loanBorrower.value;
  const amount = loanAmount.value;
  const interest = loanInterest.value;
  const start = loanStart.value;
  const due = loanDue.value;
  const status = loanStatus.value;

  let url = "";
  if(id){
    url = `${API_URL}?action=updateLoan&id=${id}&borrower=${borrower}&amount=${amount}&interest=${interest}&start=${start}&due=${due}&status=${status}`;
  } else {
    url = `${API_URL}?action=addLoan&borrower=${borrower}&amount=${amount}&interest=${interest}&start=${start}&due=${due}&status=${status}`;
  }

  await fetch(url);
  loanModal.hide();
  loadLoansTable();
});

// ----------------------
// CALCULATE TOTAL PAYABLE
// ----------------------
function calculateTotalPayable(){
  const amount = Number(loanAmount.value) || 0;
  const interest = Number(loanInterest.value) || 0;
  loanTotal.value = (amount + amount * interest/100).toFixed(2);
}

loanAmount.addEventListener("input", calculateTotalPayable);
loanInterest.addEventListener("input", calculateTotalPayable);

// ----------------------
// SEARCH FUNCTION
// ----------------------
document.getElementById("searchLoan").addEventListener("input", function(){
  const term = this.value.toLowerCase();
  document.querySelectorAll("#loansTable tr").forEach(row=>{
    row.style.display = row.innerText.toLowerCase().includes(term) ? "" : "none";
  });
});

// ----------------------
// ADD LOAN BUTTON
// ----------------------
document.getElementById("addLoanBtn").addEventListener("click", async () => {
  await populateBorrowersDropdown();
  loanForm.reset();
  loanId.value = "";
  loanTotal.value = "";
  loanModal.show();
});

// ----------------------
// INITIAL LOAD
// ----------------------
populateBorrowersDropdown();
loadLoansTable();

</script>
