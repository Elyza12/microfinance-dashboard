<!DOCTYPE html>
<html>
<head>
<title>Loans</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">

<div class="container mt-4">
<h2>Loans</h2>

<form id="loanForm" class="row g-2 mb-3">
<div class="col">
<select class="form-select" id="borrowerSelect" required></select>
</div>
<div class="col">
<input type="number" id="amount" class="form-control" placeholder="Amount" required>
</div>
<div class="col">
<input type="number" id="interest" class="form-control" placeholder="Interest %" required>
</div>
<div class="col">
<input type="date" id="start" class="form-control" required>
</div>
<div class="col">
<button class="btn btn-primary">Add Loan</button>
</div>
</form>

<table class="table table-bordered bg-white">
<thead>
<tr>
<th>ID</th>
<th>Borrower</th>
<th>Total</th>
<th>Paid</th>
<th>Remaining</th>
<th>Status</th>
</tr>
</thead>
<tbody id="loansTable"></tbody>
</table>

</div>

<script>
const API_URL="https://script.google.com/macros/s/AKfycbzJPQZw9vc81-X2GzYKUB44tk7q7IJQJG7lfmVG8mAnjcBOED0Jn700WmH13-Zv2ZJTDQ/exec";

function formatDate(d){
if(!d) return "";
return new Date(d).toLocaleDateString("en-US",{year:"numeric",month:"long",day:"numeric"});
}

async function loadBorrowers(){
const res=await fetch(`${API_URL}?action=borrowers`);
const data=await res.json();
borrowerSelect.innerHTML="";
data.forEach(b=>{
borrowerSelect.innerHTML+=`<option value="${b.BorrowerID}">${b.FullName}</option>`;
});
}

async function loadLoans(){
const loansRes=await fetch(`${API_URL}?action=loans`);
const loans=await loansRes.json();
const borrowersRes=await fetch(`${API_URL}?action=borrowers`);
const borrowers=await borrowersRes.json();

let map={};
borrowers.forEach(b=>map[b.BorrowerID]=b.FullName);

loansTable.innerHTML="";
loans.forEach(l=>{
const amount=Number(l.Amount)||0;
const interest=Number(l.Interest)||0;
const paid=Number(l.Paid)||0;
const total=amount+amount*interest/100;
const remaining=total-paid;

loansTable.innerHTML+=`
<tr>
<td>${l.LoanID}</td>
<td>${map[l.BorrowerID]||""}</td>
<td>₱${total.toFixed(2)}</td>
<td>₱${paid.toFixed(2)}</td>
<td>₱${remaining.toFixed(2)}</td>
<td>${l.Status}</td>
</tr>`;
});
}

loanForm.addEventListener("submit",async e=>{
e.preventDefault();
const startDate=new Date(start.value);
const dueDate=new Date(startDate);
dueDate.setDate(dueDate.getDate()+30);

await fetch(`${API_URL}?action=addLoan&borrower=${borrowerSelect.value}&amount=${amount.value}&interest=${interest.value}&start=${start.value}&due=${dueDate.toISOString().split("T")[0]}`);
loanForm.reset();
loadLoans();
});

loadBorrowers();
loadLoans();
</script>

</body>
</html>
