<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body>

<div class="container mt-5">

  <h1 class="text-center mb-4">Dashboard</h1>

  <!-- Stats Cards -->
  <div class="row g-3 mb-4">
    <div class="col-md-3">
      <div class="card text-bg-primary">
        <div class="card-body">
          <h5 class="card-title">Total Borrowers</h5>
          <p class="card-text fs-3" id="totalBorrowers">0</p>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card text-bg-success">
        <div class="card-body">
          <h5 class="card-title">Total Loans</h5>
          <p class="card-text fs-3" id="totalLoans">0</p>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card text-bg-warning">
        <div class="card-body">
          <h5 class="card-title">Total Collection</h5>
          <p class="card-text fs-3" id="totalCollection">0</p>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card text-bg-danger">
        <div class="card-body">
          <h5 class="card-title">Overdue Loans</h5>
          <p class="card-text fs-3" id="overdueLoans">0</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Loans Table -->
  <div class="mb-3 d-flex justify-content-between">
    <input type="text" id="searchLoanDashboard" class="form-control w-50" placeholder="Search loan by ID or Borrower">
    <button class="btn btn-success" id="addLoanBtnDashboard">Add Loan</button>
  </div>

  <table class="table table-striped">
    <thead>
      <tr>
        <th>Loan ID</th>
        <th>Borrower</th>
        <th>Amount</th>
        <th>Interest</th>
        <th>Total Payable</th>
        <th>Remaining Balance</th>
        <th>Start Date</th>
        <th>Due Date</th>
        <th>Status</th>
      </tr>
    </thead>
    <tbody id="loansTableDashboard"></tbody>
  </table>

</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbzJPQZw9vc81-X2GzYKUB44tk7q7IJQJG7lfmVG8mAnjcBOED0Jn700WmH13-Zv2ZJTDQ/exec";

if(localStorage.getItem("loggedIn") !== "true"){
  window.location.href = "login.html";
}

function formatDate(dateString){
  if(!dateString) return "";
  const options = { year: 'numeric', month: 'long', day: 'numeric' };
  return new Date(dateString).toLocaleDateString('en-US', options);
}

async function fetchBorrowers(){  
  const res = await fetch(`${API_URL}?action=borrowers`);
  return await res.json();
}

async function fetchLoans(){  
  const res = await fetch(`${API_URL}?action=loans`);
  return await res.json();
}

async function loadDashboard(){
  const borrowers = await fetchBorrowers();
  const loans = await fetchLoans();

  document.getElementById("totalBorrowers").innerText = borrowers.length;
  document.getElementById("totalLoans").innerText = loans.length;

  let totalCollection = 0;
  let overdueCount = 0;
  const today = new Date();

  const borrowersMap = {};
  borrowers.forEach(b => borrowersMap[b.BorrowerID] = b.FullName);

  const table = document.getElementById("loansTableDashboard");
  table.innerHTML = "";

  loans.forEach(loan => {
    const totalPayable = Number(loan.Amount) + (Number(loan.Amount) * Number(loan.Interest)/100);
    const remaining = loan.RemainingBalance ?? totalPayable;
    totalCollection += totalPayable - remaining;

    const dueDate = new Date(loan.DueDate);
    if(dueDate < today && remaining > 0) overdueCount++;

    table.innerHTML += `
<tr>
<td>${loan.LoanID}</td>
<td>${borrowersMap[loan.BorrowerID] || ""}</td>
<td>${loan.Amount}</td>
<td>${loan.Interest}</td>
<td>${totalPayable.toFixed(2)}</td>
<td>${remaining.toFixed(2)}</td>
<td>${formatDate(loan.StartDate)}</td>
<td>${formatDate(loan.DueDate)}</td>
<td>${loan.Status}</td>
</tr>`;
  });

  document.getElementById("totalCollection").innerText = totalCollection.toFixed(2);
  document.getElementById("overdueLoans").innerText = overdueCount;
}

// Simple search in dashboard table
document.getElementById("searchLoanDashboard").addEventListener("input", function(){
  const term = this.value.toLowerCase();
  document.querySelectorAll("#loansTableDashboard tr").forEach(row=>{
    row.style.display = row.innerText.toLowerCase().includes(term) ? "" : "none";
  });
});

loadDashboard();
</script>

</body>
</html>
