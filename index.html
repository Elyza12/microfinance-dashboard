<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body{
      margin:0;
      font-family:Segoe UI, Arial;
      background:#0f172a;
      color:white;
    }

    .layout{
      display:flex;
      height:100vh;
    }

    .sidebar{
      width:240px;
      background:#111827;
      padding:20px;
    }

    .sidebar h2{
      margin-bottom:30px;
      font-size:20px;
    }

    .sidebar button{
      width:100%;
      padding:12px;
      margin-bottom:10px;
      border:none;
      border-radius:8px;
      background:#1f2937;
      color:white;
      cursor:pointer;
    }

    .sidebar button:hover{
      background:#2563eb;
    }

    .main{
      flex:1;
      padding:25px;
      overflow:auto;
    }

    .cards{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
      gap:15px;
      margin-bottom:25px;
    }

    .card{
      background:#1e293b;
      padding:20px;
      border-radius:12px;
      box-shadow:0 4px 12px rgba(0,0,0,0.4);
    }

    table{
      width:100%;
      border-collapse:collapse;
      margin-top:15px;
    }

    th, td{
      padding:10px;
      border-bottom:1px solid #334155;
    }

    th{
      text-align:left;
      background:#1e293b;
    }

    .btn{
      padding:6px 10px;
      border:none;
      border-radius:6px;
      cursor:pointer;
      color:white;
    }

    .btn-primary{background:#2563eb;}
    .btn-success{background:#16a34a;}
    .btn-danger{background:#dc2626;}
    .btn-warning{background:#f59e0b;}

    .overdue{
      background:#7f1d1d;
    }

    .modal{
      display:none;
      position:fixed;
      top:0;
      left:0;
      width:100%;
      height:100%;
      background:rgba(0,0,0,0.6);
      justify-content:center;
      align-items:center;
    }

    .modal-content{
      background:#1e293b;
      padding:25px;
      border-radius:10px;
      width:350px;
    }

    input{
      width:100%;
      padding:8px;
      margin-bottom:10px;
      border-radius:6px;
      border:1px solid #334155;
      background:#0f172a;
      color:white;
    }

  </style>
</head>

<body>

<div class="layout">

  <div class="sidebar">
    <h2>Enterprise MicroFinance</h2>
    <button onclick="loadDashboard()">Dashboard</button>
    <button onclick="loadBorrowers()">Borrowers</button>
    <button onclick="loadLoans()">Loans</button>
    <button onclick="loadPayments()">Payments</button>
  </div>

  <div class="main">
    <div id="content"></div>
  </div>

</div>

<!-- MODAL -->
<div class="modal" id="modal">
  <div class="modal-content" id="modalContent"></div>
</div>

<script>

/* ================= DASHBOARD ================= */

function loadDashboard(){
  google.script.run.withSuccessHandler(function(loans){
    let active=0, capital=0, overdue=0;
    const today=new Date();

    for(let i=1;i<loans.length;i++){
      if(loans[i][9]=="Ongoing"){
        active++;
        capital+=Number(loans[i][10]);
        if(new Date(loans[i][8])<today){overdue++;}
      }
    }

    document.getElementById("content").innerHTML=`
      <div class="cards">
        <div class="card"><h3>Active Loans</h3><h2>${active}</h2></div>
        <div class="card"><h3>Total Outstanding</h3><h2>₱ ${capital}</h2></div>
        <div class="card"><h3>Overdue Loans</h3><h2>${overdue}</h2></div>
      </div>
      <div class="card">
        <canvas id="loanChart"></canvas>
      </div>
    `;

    const ctx=document.getElementById("loanChart");
    new Chart(ctx,{
      type:'doughnut',
      data:{
        labels:['Active','Overdue'],
        datasets:[{
          data:[active,overdue]
        }]
      }
    });

  }).getLoans();
}

/* ================= BORROWERS ================= */

function loadBorrowers(){
  google.script.run.withSuccessHandler(function(data){
    let html=`<div class="card">
      <button class="btn btn-primary" onclick="showAddBorrower()">+ Add Borrower</button>
      <table>
      <tr><th>Name</th><th>Phone</th><th>Status</th><th>Action</th></tr>`;

    for(let i=1;i<data.length;i++){
      html+=`
        <tr>
          <td>${data[i][1]}</td>
          <td>${data[i][2]}</td>
          <td>${data[i][4]}</td>
          <td>
            <button class="btn btn-success" onclick="showLoanModal('${data[i][0]}','${data[i][1]}')">Loan</button>
          </td>
        </tr>`;
    }

    html+=`</table></div>`;
    document.getElementById("content").innerHTML=html;
  }).getBorrowers();
}

function showAddBorrower(){
  openModal(`
    <h3>Add Borrower</h3>
    <input id="bname" placeholder="Full Name">
    <input id="bphone" placeholder="Phone">
    <input id="baddress" placeholder="Address">
    <button class="btn btn-success" onclick="saveBorrower()">Save</button>
  `);
}

function saveBorrower(){
  google.script.run.withSuccessHandler(()=>{
    closeModal();
    loadBorrowers();
  }).addBorrower({
    name:bname.value,
    phone:bphone.value,
    address:baddress.value
  });
}

/* ================= LOAN ================= */

function showLoanModal(id,name){
  openModal(`
    <h3>Release Loan - ${name}</h3>
    <input id="principal" placeholder="Principal">
    <input id="interest" placeholder="Interest %">
    <input id="term" placeholder="Term (days)">
    <input type="date" id="startDate">
    <button class="btn btn-success" onclick="saveLoan('${id}','${name}')">Release</button>
  `);
}

function saveLoan(id,name){
  google.script.run.withSuccessHandler(()=>{
    closeModal();
    loadLoans();
  }).addLoan({
    borrowerId:id,
    borrowerName:name,
    principal:principal.value,
    interest:interest.value,
    term:term.value,
    startDate:startDate.value
  });
}

/* ================= LOANS ================= */

function loadLoans(){
  google.script.run.withSuccessHandler(function(data){
    let html=`<div class="card"><table>
      <tr><th>Borrower</th><th>Balance</th><th>Due</th><th>Status</th></tr>`;

    const today=new Date();

    for(let i=1;i<data.length;i++){
      const due=new Date(data[i][8]);
      const overdue=due<today && data[i][9]=="Ongoing";

      html+=`
        <tr class="${overdue?'overdue':''}">
          <td>${data[i][2]}</td>
          <td>₱ ${data[i][10]}</td>
          <td>${due.toLocaleDateString()}</td>
          <td>${data[i][9]}</td>
        </tr>`;
    }

    html+=`</table></div>`;
    document.getElementById("content").innerHTML=html;
  }).getLoans();
}

/* ================= MODAL ================= */

function openModal(content){
  document.getElementById("modalContent").innerHTML=content;
  document.getElementById("modal").style.display="flex";
}

function closeModal(){
  document.getElementById("modal").style.display="none";
}

window.onclick=function(e){
  if(e.target==document.getElementById("modal")){
    closeModal();
  }
};

loadDashboard();

</script>

</body>
</html>
