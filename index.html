<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Microfinance Admin</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
body {
    background: #f5f7fb;
    font-family: Arial, sans-serif;
}
.sidebar {
    width: 240px;
    min-height: 100vh;
    background: #1e293b;
}
.sidebar .nav-link {
    color: #cbd5e1;
    margin-bottom: 10px;
}
.sidebar .nav-link:hover {
    background: #334155;
    border-radius: 8px;
    color: white;
}
.sidebar .active {
    background: #0d6efd;
    border-radius: 8px;
    color: white !important;
}
.main-content {
    background: #f1f5f9;
    min-height: 100vh;
}
.dashboard-card {
    border: none;
    border-radius: 14px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.05);
}
</style>
</head>
<body>

<div class="d-flex">

<div class="sidebar p-3">
    <h4 class="text-white">MicroFinance</h4>
    <hr class="text-white">
    <ul class="nav flex-column">
        <li class="nav-item"><a class="nav-link active" href="index.html">Dashboard</a></li>
        <li class="nav-item"><a class="nav-link" href="borrowers.html">Borrowers</a></li>
        <li class="nav-item"><a class="nav-link" href="loans.html">Loans</a></li>
        <li class="nav-item"><a class="nav-link" href="payments.html">Payments</a></li>
    </ul>
    <button id="logoutBtn" class="btn btn-danger mt-3 w-100">Logout</button>
</div>

<div class="main-content flex-grow-1">
    <nav class="navbar navbar-light bg-white shadow-sm px-4">
        <span class="navbar-brand">Admin Dashboard</span>
    </nav>

    <div class="container-fluid mt-4">

        <div class="row g-4 mt-4">
            <div class="col-md-3">
                <div class="card dashboard-card text-white" style="background-color:#0d6efd;">
                    <div class="card-body">
                        <h6>Total Loans</h6>
                        <h3 id="totalLoans">0</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card dashboard-card text-white" style="background-color:#ffc107;">
                    <div class="card-body">
                        <h6>Today's Collection</h6>
                        <h3 id="todayCollection">₱0</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card dashboard-card text-white" style="background-color:#198754;">
                    <div class="card-body">
                        <h6>Active Borrowers</h6>
                        <h3 id="activeBorrowers">0</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card dashboard-card text-white" style="background-color:#dc3545;">
                    <div class="card-body">
                        <h6>Overdue Loans</h6>
                        <h3 id="overdueLoans">0</h3>
                    </div>
                </div>
            </div>
        </div>

        <div class="card mt-4">
            <div class="card-header">Recent Loans</div>
            <div class="card-body">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Borrower</th>
                            <th>Amount</th>
                            <th>Status</th>
                            <th>Date</th>
                        </tr>
                    </thead>
                    <tbody id="loanTable"></tbody>
                </table>
            </div>
        </div>

    </div>
</div>
</div>

<script>
if(localStorage.getItem("loggedIn") !== "true"){
    window.location.href = "login.html";
}

document.getElementById("logoutBtn").addEventListener("click", () => {
    localStorage.removeItem("loggedIn");
    window.location.href = "login.html";
});

const API_URL = "https://script.google.com/macros/s/AKfycbzJPQZw9vc81-X2GzYKUB44tk7q7IJQJG7lfmVG8mAnjcBOED0Jn700WmH13-Zv2ZJTDQ/exec";

async function fetchData(action) {
    try {
        const res = await fetch(`${API_URL}?action=${action}`);
        const data = await res.json();
        return Array.isArray(data) ? data : [];
    } catch(err) {
        console.error("Fetch error:", err);
        return [];
    }
}

async function updateDashboard() {
    const borrowers = await fetchData("borrowers");
    const loans = await fetchData("loans");
    const payments = await fetchData("payments");

    // Active Borrowers
    const activeBorrowers = borrowers.filter(b =>
        String(b.Status || "").trim().toLowerCase() === "active"
    ).length;

    // Total Loans
    const totalLoans = loans.length;

    // ✅ AUTOMATIC OVERDUE DETECTION
    const today = new Date();
    const overdueLoans = loans.filter(l => {
        if (!l.DueDate) return false;

        const dueDate = new Date(l.DueDate);
        const status = String(l.Status || "").toLowerCase();

        return dueDate < today && status !== "paid";
    }).length;

    // Today's Collection
    const todayStr = new Date().toISOString().split("T")[0];
    const todayPayments = payments.filter(p => {
        if (!p.Date) return false;
        return new Date(p.Date).toISOString().split("T")[0] === todayStr;
    });

    const totalToday = todayPayments.reduce((sum,p)=>
        sum + Number(p.AmountPaid || 0),0
    );

    document.getElementById("activeBorrowers").innerText = activeBorrowers;
    document.getElementById("totalLoans").innerText = totalLoans;
    document.getElementById("overdueLoans").innerText = overdueLoans;
    document.getElementById("todayCollection").innerText = `₱${totalToday.toFixed(2)}`;
}

async function updateRecentLoans() {
    const loans = await fetchData("loans");
    const borrowers = await fetchData("borrowers");

    const table = document.getElementById("loanTable");
    table.innerHTML = "";

    loans.sort((a,b)=> new Date(b.StartDate) - new Date(a.StartDate));

    loans.slice(0,5).forEach(loan => {
        const borrower = borrowers.find(b => b.BorrowerID === loan.BorrowerID);
        const borrowerName = borrower ? borrower.FullName : "Unknown";
        const formattedDate = loan.StartDate ?
            new Date(loan.StartDate).toLocaleDateString("en-US",
            {year:"numeric",month:"long",day:"numeric"}) : "";

        table.innerHTML += `<tr>
            <td>${borrowerName}</td>
            <td>₱${Number(loan.Amount || 0).toFixed(2)}</td>
            <td>${loan.Status || ""}</td>
            <td>${formattedDate}</td>
        </tr>`;
    });
}

updateDashboard();
updateRecentLoans();
</script>

</body>
</html>
