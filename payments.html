<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Payments - Microfinance Admin</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
body {
    background: #f5f7fb;
    font-family: Arial, sans-serif;
}
.sidebar {
    width: 240px;
    min-height: 100vh;
    background: #1e293b;
}
.sidebar .nav-link {
    color: #cbd5e1;
    margin-bottom: 10px;
}
.sidebar .nav-link:hover {
    background: #334155;
    border-radius: 8px;
    color: white;
}
.sidebar .active {
    background: #0d6efd;
    border-radius: 8px;
    color: white !important;
}
.main-content {
    background: #f1f5f9;
    min-height: 100vh;
}
.card-custom {
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.05);
}
</style>
</head>
<body>

<div class="d-flex">

<!-- SIDEBAR -->
<div class="sidebar p-3">
    <h4 class="text-white">MicroFinance</h4>
    <hr class="text-white">
    <ul class="nav flex-column">
        <li class="nav-item"><a class="nav-link" href="index.html">Dashboard</a></li>
        <li class="nav-item"><a class="nav-link" href="borrowers.html">Borrowers</a></li>
        <li class="nav-item"><a class="nav-link" href="loans.html">Loans</a></li>
        <li class="nav-item"><a class="nav-link active" href="payments.html">Payments</a></li>
    </ul>
    <button id="logoutBtn" class="btn btn-danger mt-3 w-100">Logout</button>
</div>

<!-- MAIN CONTENT -->
<div class="main-content flex-grow-1">
    <nav class="navbar navbar-light bg-white shadow-sm px-4">
        <span class="navbar-brand">Payments</span>
    </nav>

    <div class="container-fluid mt-4">

        <div class="card card-custom p-4">
            <h5>Record a Payment</h5>
            <form id="paymentForm">
                <div class="mb-3">
                    <label for="borrowerId" class="form-label">Borrower ID</label>
                    <input type="text" id="borrowerId" class="form-control" placeholder="Enter Borrower ID" required>
                </div>
                <div class="mb-3">
                    <label for="amountPaid" class="form-label">Amount Paid</label>
                    <input type="number" id="amountPaid" class="form-control" placeholder="Enter Amount Paid" required>
                </div>
                <div class="mb-3">
                    <label for="paymentDate" class="form-label">Payment Date</label>
                    <input type="date" id="paymentDate" class="form-control" required>
                </div>
                <button type="submit" class="btn btn-success">Submit Payment</button>
            </form>
            <div id="formMsg" class="mt-3"></div>
        </div>

        <div class="card card-custom mt-4 p-4">
            <h5>Recent Payments</h5>
            <table class="table table-striped mt-3">
                <thead>
                    <tr>
                        <th>Borrower</th>
                        <th>Amount Paid</th>
                        <th>Date</th>
                    </tr>
                </thead>
                <tbody id="paymentsTable"></tbody>
            </table>
        </div>

    </div>
</div>

</div>

<script>
// LOGIN CHECK
if(localStorage.getItem("loggedIn") !== "true"){
    window.location.href = "login.html";
}

// LOGOUT
document.getElementById("logoutBtn").addEventListener("click", () => {
    localStorage.removeItem("loggedIn");
    window.location.href = "login.html";
});

const API_URL = "https://script.google.com/macros/s/AKfycbzJPQZw9vc81-X2GzYKUB44tk7q7IJQJG7lfmVG8mAnjcBOED0Jn700WmH13-Zv2ZJTDQ/exec";

// FETCH DATA
async function fetchData(action) {
    try {
        const res = await fetch(`${API_URL}?action=${action}`);
        const data = await res.json();
        return Array.isArray(data) ? data : [];
    } catch(err) {
        console.error("Fetch error:", err);
        return [];
    }
}

// SUBMIT PAYMENT
document.getElementById("paymentForm").addEventListener("submit", async (e)=>{
    e.preventDefault();

    const borrowerId = document.getElementById("borrowerId").value.trim();
    const amountPaid = parseFloat(document.getElementById("amountPaid").value);
    const paymentDate = document.getElementById("paymentDate").value;

    if(!borrowerId || isNaN(amountPaid) || !paymentDate) return;

    const payload = {
        BorrowerID: borrowerId,
        AmountPaid: amountPaid,
        Date: paymentDate
    };

    try {
        const res = await fetch(`${API_URL}?action=addPayment&data=${encodeURIComponent(JSON.stringify(payload))}`);
        const result = await res.json();
        document.getElementById("formMsg").innerHTML = `<span class="text-success">Payment recorded successfully!</span>`;
        document.getElementById("paymentForm").reset();
        loadRecentPayments();
    } catch(err) {
        console.error(err);
        document.getElementById("formMsg").innerHTML = `<span class="text-danger">Failed to record payment.</span>`;
    }
});

// LOAD RECENT PAYMENTS
async function loadRecentPayments() {
    const payments = await fetchData("payments");
    const borrowers = await fetchData("borrowers");

    const table = document.getElementById("paymentsTable");
    table.innerHTML = "";

    payments.sort((a,b) => new Date(b.Date) - new Date(a.Date));

    payments.slice(0,5).forEach(p => {
        const borrower = borrowers.find(b=>b.BorrowerID === p.BorrowerID);
        const borrowerName = borrower ? borrower.FullName : "Unknown";
        const paymentDate = p.Date ? new Date(p.Date).toLocaleDateString("en-US",{year:"numeric",month:"long",day:"numeric"}) : "";
        table.innerHTML += `<tr>
            <td>${borrowerName}</td>
            <td>â‚±${Number(p.AmountPaid || 0).toFixed(2)}</td>
            <td>${paymentDate}</td>
        </tr>`;
    });
}

// INITIAL LOAD
loadRecentPayments();

</script>
</body>
</html>
