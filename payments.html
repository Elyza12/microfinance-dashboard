<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Payments - Microfinance Admin</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
body { background:#f5f7fb; font-family:Arial; }
.sidebar { width:240px; min-height:100vh; background:#1e293b; }
.sidebar .nav-link { color:#cbd5e1; margin-bottom:10px; }
.sidebar .nav-link:hover { background:#334155; border-radius:8px; color:white; }
.sidebar .active { background:#0d6efd; border-radius:8px; color:white!important; }
.main-content { background:#f1f5f9; min-height:100vh; }
.card-custom { border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.05); }
.info-box { background:white; padding:15px; border-radius:10px; margin-bottom:10px; }
</style>
</head>
<body>

<div class="d-flex">
<div class="sidebar p-3">
<h4 class="text-white">MicroFinance</h4>
<hr class="text-white">
<ul class="nav flex-column">
<li class="nav-item"><a class="nav-link" href="index.html">Dashboard</a></li>
<li class="nav-item"><a class="nav-link" href="borrowers.html">Borrowers</a></li>
<li class="nav-item"><a class="nav-link" href="loans.html">Loans</a></li>
<li class="nav-item"><a class="nav-link active" href="payments.html">Payments</a></li>
</ul>
<button id="logoutBtn" class="btn btn-danger mt-3 w-100">Logout</button>
</div>

<div class="main-content flex-grow-1">
<nav class="navbar navbar-light bg-white shadow-sm px-4">
<span class="navbar-brand">Payments PRO</span>
</nav>

<div class="container-fluid mt-4">
<div class="card card-custom p-4">
<h5>Record Payment</h5>

<div class="mb-3">
<label class="form-label">Select Borrower</label>
<select id="borrowerSelect" class="form-select"></select>
</div>

<div id="loanInfo" class="mb-3"></div>

<div class="mb-3">
<label class="form-label">Amount Paid</label>
<input type="number" id="amountPaid" class="form-control">
</div>

<button class="btn btn-success" onclick="submitPayment()">Submit Payment</button>
<div id="msg" class="mt-3"></div>
</div>
</div>
</div>

<script>
if(localStorage.getItem("loggedIn")!=="true"){ window.location.href="login.html"; }

const API_URL="https://script.google.com/macros/s/AKfycbzJPQZw9vc81-X2GzYKUB44tk7q7IJQJG7lfmVG8mAnjcBOED0Jn700WmH13-Zv2ZJTDQ/exec";

let loansData = [];
let selectedLoan = null;

async function fetchData(action){ const res=await fetch(`${API_URL}?action=${action}`); return await res.json(); }

async function loadData(){
    const borrowers = await fetchData("borrowers");
    loansData = await fetchData("loans");

    const select = document.getElementById("borrowerSelect");
    select.innerHTML = '<option value="">Select Borrower</option>';

    borrowers.forEach(b=>{
        if(b.Status?.toLowerCase()==="active"){
            select.innerHTML += `<option value="${b.BorrowerID}">${b.FullName}</option>`;
        }
    });

    // Preselect loan if redirected from Loans page
    const preLoanId = localStorage.getItem("selectedLoanId");
    const preBorrowerId = localStorage.getItem("selectedBorrowerId");
    if(preBorrowerId){
        select.value = preBorrowerId;
        select.dispatchEvent(new Event('change'));
        localStorage.removeItem("selectedLoanId");
        localStorage.removeItem("selectedBorrowerId");
    }
}

document.getElementById("borrowerSelect").addEventListener("change", function(){
    const borrowerId=this.value;
    selectedLoan = loansData.find(l=>l.BorrowerID===borrowerId && l.Status?.toLowerCase()!=="paid");
    if(!selectedLoan){
        document.getElementById("loanInfo").innerHTML=`<div class="alert alert-warning">No active loan found.</div>`;
        return;
    }
    const amount = Number(selectedLoan.Amount);
    const interest = Number(selectedLoan.Interest);
    const total = amount + amount*interest/100;
    const paid = Number(selectedLoan.Paid || 0);
    const remaining = total - paid;
    document.getElementById("loanInfo").innerHTML = `
        <div class="info-box">
        <strong>Loan Amount:</strong> ₱${amount.toFixed(2)} <br>
        <strong>Interest:</strong> ${interest}% <br>
        <strong>Total Payable:</strong> ₱${total.toFixed(2)} <br>
        <strong>Already Paid:</strong> ₱${paid.toFixed(2)} <br>
        <strong>Remaining Balance:</strong> ₱${remaining.toFixed(2)}
        </div>`;
});

async function submitPayment(){
    if(!selectedLoan){ alert("Select borrower first"); return; }
    const amountPaid = Number(document.getElementById("amountPaid").value);
    if(amountPaid <=0){ alert("Invalid amount"); return; }

    // Add payment and update loan Paid/Status via API
    await fetch(`${API_URL}?action=makePayment&id=${selectedLoan.LoanID}&amount=${amountPaid}`);

    document.getElementById("msg").innerHTML=`<div class="alert alert-success">Payment Recorded</div>`;
    document.getElementById("amountPaid").value="";
    loadData();
}

loadData();

</script>
</body>
</html>
