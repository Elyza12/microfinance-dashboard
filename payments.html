<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Payments</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body>

<h1 class="text-center mt-5">Payments Page</h1>
<p class="text-center">Record payments for loans.</p>

<div class="container mt-4">
<div class="mb-3 d-flex justify-content-between">
<input type="text" id="searchPayment" class="form-control w-50" placeholder="Search payment by Borrower or Loan ID">
<button class="btn btn-success" id="addPaymentBtn">Add Payment</button>
</div>

<table class="table table-striped">
<thead>
<tr>
<th>Payment ID</th>
<th>Borrower</th>
<th>Loan ID</th>
<th>Amount Paid</th>
<th>Remaining Balance</th>
<th>Date Paid</th>
<th>Actions</th>
</tr>
</thead>
<tbody id="paymentsTable"></tbody>
</table>
</div>

<!-- Payment Modal -->
<div class="modal fade" id="paymentModal" tabindex="-1">
<div class="modal-dialog">
<div class="modal-content">
<div class="modal-header">
<h5 class="modal-title">Payment</h5>
<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
</div>
<div class="modal-body">
<form id="paymentForm">
<input type="hidden" id="paymentId">
<div class="mb-3">
<label class="form-label">Borrower</label>
<select id="paymentBorrower" class="form-control" required></select>
</div>

<div class="mb-3">
<label class="form-label">Loan</label>
<select id="paymentLoan" class="form-control" required></select>
</div>

<div class="mb-3">
<label class="form-label">Amount Paid</label>
<input type="number" id="paymentAmount" class="form-control" required>
</div>

<div class="mb-3">
<label class="form-label">Date Paid</label>
<input type="date" id="paymentDate" class="form-control" required>
</div>

<button type="submit" class="btn btn-primary w-100">Save Payment</button>
</form>
</div>
</div>
</div>
</div>

<script>
// LOGIN CHECK
if(localStorage.getItem("loggedIn")!=="true") window.location.href="login.html";

// API
const API_URL = "https://script.google.com/macros/s/AKfycbzJPQZw9vc81-X2GzYKUB44tk7q7IJQJG7lfmVG8mAnjcBOED0Jn700WmH13-Zv2ZJTDQ/exec";

const paymentId = document.getElementById("paymentId");
const paymentBorrower = document.getElementById("paymentBorrower");
const paymentLoan = document.getElementById("paymentLoan");
const paymentAmount = document.getElementById("paymentAmount");
const paymentDate = document.getElementById("paymentDate");
const paymentForm = document.getElementById("paymentForm");

// FORMAT DATE
function formatDate(dateString){
    if(!dateString) return "";
    const date = new Date(dateString);
    return date.toLocaleDateString("en-US",{year:"numeric",month:"long",day:"numeric"});
}

// FETCH DATA
async function fetchData(action){
    try{
        const res = await fetch(`${API_URL}?action=${action}`);
        const data = await res.json();
        return Array.isArray(data)? data : [];
    }catch(e){
        console.error(e);
        return [];
    }
}

// POPULATE BORROWERS DROPDOWN
async function populateBorrowersDropdown(){
    const borrowers = await fetchData("borrowers");
    paymentBorrower.innerHTML = "";
    borrowers.forEach(b=>{
        paymentBorrower.innerHTML += `<option value="${b.BorrowerID}">${b.FullName}</option>`;
    });
}

// POPULATE LOANS DROPDOWN BASED ON BORROWER
async function populateLoansDropdown(){
    const loans = await fetchData("loans");
    paymentLoan.innerHTML = "";
    const borrowerId = paymentBorrower.value;
    loans.filter(l => l.BorrowerID === borrowerId).forEach(l=>{
        const amount = Number(l.Amount || 0);
        const interest = Number(l.Interest || 0);
        const paid = Number(l.Paid || 0);
        const totalPayable = amount + (amount*interest/100);
        const remaining = Math.max(totalPayable - paid,0);
        paymentLoan.innerHTML += `<option value="${l.LoanID}" data-remaining="${remaining}">${l.LoanID} - Remaining ₱${remaining.toFixed(2)}</option>`;
    });
}

// LOAD PAYMENTS TABLE
async function loadPaymentsTable(){
    const payments = await fetchData("payments");
    const borrowers = await fetchData("borrowers");
    const loans = await fetchData("loans");
    const borrowerMap = {};
    borrowers.forEach(b=>borrowerMap[b.BorrowerID]=b.FullName);
    const loanMap = {};
    loans.forEach(l=>{
        const amount = Number(l.Amount || 0);
        const interest = Number(l.Interest || 0);
        const paid = Number(l.Paid || 0);
        const totalPayable = amount + (amount*interest/100);
        const remaining = Math.max(totalPayable - paid,0);
        loanMap[l.LoanID]={totalPayable, remaining};
    });

    const table = document.getElementById("paymentsTable");
    table.innerHTML = "";
    payments.forEach(p=>{
        const borrowerName = borrowerMap[p.BorrowerID] || "Unknown";
        const loan = loanMap[p.LoanID] || {totalPayable:0, remaining:0};
        const amountPaid = Number(p.Amount || 0);
        const remaining = Math.max(loan.totalPayable - amountPaid,0);
        table.innerHTML += `
        <tr>
            <td>${p.PaymentID}</td>
            <td>${borrowerName}</td>
            <td>${p.LoanID}</td>
            <td>₱${amountPaid.toFixed(2)}</td>
            <td>₱${remaining.toFixed(2)}</td>
            <td>${formatDate(p.DatePaid)}</td>
            <td>
                <button class="btn btn-danger btn-sm deletePaymentBtn" data-id="${p.PaymentID}">Delete</button>
            </td>
        </tr>`;
    });
}

// MODAL
const paymentModal = new bootstrap.Modal(document.getElementById("paymentModal"));

// ADD PAYMENT BUTTON
document.getElementById("addPaymentBtn").addEventListener("click", async ()=>{
    await populateBorrowersDropdown();
    await populateLoansDropdown();
    paymentForm.reset();
    paymentId.value="";
    paymentModal.show();
});

// UPDATE LOANS DROPDOWN WHEN BORROWER CHANGES
paymentBorrower.addEventListener("change", populateLoansDropdown);

// FORM SUBMIT
paymentForm.addEventListener("submit", async e=>{
    e.preventDefault();
    const id = paymentId.value;
    let url;
    if(id){
        url = `${API_URL}?action=updatePayment&id=${id}&borrower=${paymentBorrower.value}&loan=${paymentLoan.value}&amount=${paymentAmount.value}&date=${paymentDate.value}`;
    }else{
        url = `${API_URL}?action=addPayment&borrower=${paymentBorrower.value}&loan=${paymentLoan.value}&amount=${paymentAmount.value}&date=${paymentDate.value}`;
    }
    await fetch(url);
    paymentModal.hide();
    loadPaymentsTable();
});

// DELETE PAYMENT
document.addEventListener("click", async e=>{
    if(e.target.classList.contains("deletePaymentBtn")){
        if(confirm("Delete payment?")){
            await fetch(`${API_URL}?action=deletePayment&id=${e.target.dataset.id}`);
            loadPaymentsTable();
        }
    }
});

// SEARCH
document.getElementById("searchPayment").addEventListener("input", function(){
    const term = this.value.toLowerCase();
    document.querySelectorAll("#paymentsTable tr").forEach(row=>{
        row.style.display = row.innerText.toLowerCase().includes(term) ? "" : "none";
    });
});

// INITIAL LOAD
populateBorrowersDropdown();
populateLoansDropdown();
loadPaymentsTable();
</script>
</body>
</html>
